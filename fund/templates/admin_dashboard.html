<!-- templates/admin_dashboard.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Dashboard - Crowd-Funding Platform{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        transition: transform 0.2s;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }
    .stats-card {
        text-align: center;
        padding: 20px;
    }
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
    }
    .stats-label {
        font-size: 1rem;
        color: #6c757d;
    }
    .nav-pills .nav-link.active {
        background-color: #0d6efd;
        border-radius: 5px;
    }
    .report-item {
        border-left: 4px solid #ffc107;
        padding-left: 15px;
        margin-bottom: 15px;
    }
    .resolved {
        border-left-color: #198754;
    }
    .table-responsive {
        border-radius: 10px;
        overflow: hidden;
    }
    .badge-featured {
        background-color: #ffc107;
        color: #000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard</h1>
        <div>
            <a href="{% url 'admin:index' %}" class="btn btn-outline-primary">
                <i class="fas fa-cog me-1"></i> Django Admin
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card dashboard-card bg-primary text-white">
                <div class="stats-card">
                    <div class="stats-number">{{ total_projects }}</div>
                    <div class="stats-label">Total Projects</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card dashboard-card bg-success text-white">
                <div class="stats-card">
                    <div class="stats-number">{{ active_projects }}</div>
                    <div class="stats-label">Active Projects</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card dashboard-card bg-info text-white">
                <div class="stats-card">
                    <div class="stats-number">{{ completed_projects }}</div>
                    <div class="stats-label">Completed</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card dashboard-card bg-warning text-dark">
                <div class="stats-card">
                    <div class="stats-number">{{ canceled_projects }}</div>
                    <div class="stats-label">Canceled</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-pills mb-4" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="featured-tab" data-bs-toggle="pill" data-bs-target="#featured" type="button" role="tab">
                Featured Projects
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="projects-tab" data-bs-toggle="pill" data-bs-target="#projects" type="button" role="tab">
                All Projects
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="project-reports-tab" data-bs-toggle="pill" data-bs-target="#project-reports" type="button" role="tab">
                Project Reports ({{ reported_projects|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="comment-reports-tab" data-bs-toggle="pill" data-bs-target="#comment-reports" type="button" role="tab">
                Comment Reports ({{ reported_comments|length }})
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="adminTabsContent">
        <!-- Featured Projects Tab -->
        <div class="tab-pane fade show active" id="featured" role="tabpanel">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Manage Featured Projects</h5>
                    <p class="text-muted mb-0">These projects are displayed on the homepage</p>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Creator</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Rating</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for project in featured_projects %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if project.pictures.all %}
                                            <img src="{{ project.pictures.first.image.url }}" alt="{{ project.title }}" class="rounded me-2" width="40" height="40" style="object-fit: cover;">
                                            {% endif %}
                                            <div>
                                                <strong>{{ project.title }}</strong>
                                                <br>
                                                <small class="text-muted">Created: {{ project.created_at|date:"M d, Y" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ project.creator.get_full_name }}</td>
                                    <td>{{ project.get_category_display_name }}</td>
                                    <td>
                                        <span class="badge bg-{% if project.status == 'active' %}success{% elif project.status == 'completed' %}info{% else %}warning{% endif %}">
                                            {{ project.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 8px; width: 100px;">
                                            <div class="progress-bar" role="progressbar" style="width: {{ project.donation_progress }}%;"></div>
                                        </div>
                                        <small>{{ project.donation_progress|floatformat:0 }}%</small>
                                    </td>
                                    <td>
                                        {% with rating=project.average_rating %}
                                        {{ rating|floatformat:1 }} <i class="fas fa-star text-warning"></i>
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <a href="{% url 'toggle_featured_project' project.id %}" class="btn btn-sm btn-outline-danger">
                                            Remove from Featured
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">No featured projects yet.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Projects Tab -->
        <div class="tab-pane fade" id="projects" role="tabpanel">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">All Projects</h5>
                    <input type="text" class="form-control form-control-sm w-25" placeholder="Search projects..." id="projectSearch">
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="projectsTable">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Creator</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Donations</th>
                                    <th>Rating</th>
                                    <th>Featured</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for project in all_projects %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if project.pictures.all %}
                                            <img src="{{ project.pictures.first.image.url }}" alt="{{ project.title }}" class="rounded me-2" width="40" height="40" style="object-fit: cover;">
                                            {% endif %}
                                            <div>
                                                <strong>{{ project.title }}</strong>
                                                <br>
                                                <small class="text-muted">Created: {{ project.created_at|date:"M d, Y" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ project.creator.get_full_name }}</td>
                                    <td>{{ project.get_category_display_name }}</td>
                                    <td>
                                        <span class="badge bg-{% if project.status == 'active' %}success{% elif project.status == 'completed' %}info{% else %}warning{% endif %}">
                                            {{ project.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 8px; width: 100px;">
                                            <div class="progress-bar" role="progressbar" style="width: {{ project.donation_progress }}%;"></div>
                                        </div>
                                        <small>{{ project.donation_progress|floatformat:0 }}%</small>
                                    </td>
                                    <td>{{ project.donation_count }}</td>
                                    <td>
                                        {% with rating=project.rating_avg %}
                                        {{ rating|floatformat:1 }} <i class="fas fa-star text-warning"></i>
                                        {% endwith %}
                                    </td>
                                    <td>
                                        {% if project.is_featured %}
                                        <span class="badge badge-featured">Featured</span>
                                        {% else %}
                                        <a href="{% url 'toggle_featured_project' project.id %}" class="btn btn-sm btn-outline-primary">
                                            Make Featured
                                        </a>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{% url 'project_detail' project.id %}" class="btn btn-sm btn-outline-info" target="_blank">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'delete_project' project.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this project?');">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Reports Tab -->
        <div class="tab-pane fade" id="project-reports" role="tabpanel">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Reported Projects</h5>
                </div>
                <div class="card-body">
                    {% for report in reported_projects %}
                    <div class="report-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6>{{ report.project.title }}</h6>
                                <p class="mb-1">{{ report.reason }}</p>
                                <small class="text-muted">Reported by {{ report.user.get_full_name }} on {{ report.reported_at|date:"M d, Y H:i" }}</small>
                            </div>
                            <div class="btn-group">
                                <a href="{% url 'project_detail' report.project.id %}" class="btn btn-sm btn-outline-info" target="_blank">
                                    <i class="fas fa-eye"></i> View Project
                                </a>
                                <a href="{% url 'resolve_project_report' report.id %}" class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-check"></i> Resolve
                                </a>
                                <a href="{% url 'delete_project' report.project.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this project?');">
                                    <i class="fas fa-trash"></i> Delete Project
                                </a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5>No reported projects</h5>
                        <p class="text-muted">All clear! No projects have been reported.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Comment Reports Tab -->
        <div class="tab-pane fade" id="comment-reports" role="tabpanel">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Reported Comments</h5>
                </div>
                <div class="card-body">
                    {% for report in reported_comments %}
                    <div class="report-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6>Comment on: {{ report.comment.project.title }}</h6>
                                <blockquote class="blockquote mb-1">
                                    <p class="mb-0">{{ report.comment.content }}</p>
                                </blockquote>
                                <p class="mb-1 text-danger"><strong>Report Reason:</strong> {{ report.reason }}</p>
                                <small class="text-muted">
                                    Comment by {{ report.comment.user.get_full_name }} on {{ report.comment.created_at|date:"M d, Y H:i" }}<br>
                                    Reported by {{ report.user.get_full_name }} on {{ report.reported_at|date:"M d, Y H:i" }}
                                </small>
                            </div>
                            <div class="btn-group">
                                <a href="{% url 'project_detail' report.comment.project.id %}" class="btn btn-sm btn-outline-info" target="_blank">
                                    <i class="fas fa-eye"></i> View Project
                                </a>
                                <a href="{% url 'resolve_comment_report' report.id %}" class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-check"></i> Resolve
                                </a>
                                <a href="{% url 'delete_comment' report.comment.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this comment?');">
                                    <i class="fas fa-trash"></i> Delete Comment
                                </a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5>No reported comments</h5>
                        <p class="text-muted">All clear! No comments have been reported.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Project search functionality
    document.addEventListener('DOMContentLoaded', function() {
        const projectSearch = document.getElementById('projectSearch');
        const projectsTable = document.getElementById('projectsTable');
        
        if (projectSearch && projectsTable) {
            projectSearch.addEventListener('keyup', function() {
                const searchText = this.value.toLowerCase();
                const rows = projectsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const projectName = rows[i].getElementsByTagName('td')[0].textContent.toLowerCase();
                    const creatorName = rows[i].getElementsByTagName('td')[1].textContent.toLowerCase();
                    const category = rows[i].getElementsByTagName('td')[2].textContent.toLowerCase();
                    
                    if (projectName.includes(searchText) || creatorName.includes(searchText) || category.includes(searchText)) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            });
        }
        
        // Store the active tab in sessionStorage
        $('button[data-bs-toggle="pill"]').on('click', function(e) {
            localStorage.setItem('adminActiveTab', e.target.getAttribute('data-bs-target'));
        });
        
        // Get the active tab from sessionStorage
        const activeTab = localStorage.getItem('adminActiveTab');
        if (activeTab) {
            const tabTrigger = document.querySelector(`[data-bs-target="${activeTab}"]`);
            if (tabTrigger) {
                new bootstrap.Tab(tabTrigger).show();
            }
        }
    });
</script>
{% endblock %}