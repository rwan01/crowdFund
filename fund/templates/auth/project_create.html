{% extends 'base.html' %}
{% load static %}

{% block title %}Create Project - CrowdFund{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card project-card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Create New Project</h4>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">Project Title *</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                                <div class="text-danger small">{{ form.title.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Project Description *</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="text-danger small">{{ form.description.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.category.id_for_label }}" class="form-label">Category *</label>
                                    {{ form.category }}
                                    {% if form.category.errors %}
                                        <div class="text-danger small">{{ form.category.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.target_amount.id_for_label }}" class="form-label">Target Amount (EGP) *</label>
                                    {{ form.target_amount }}
                                    {% if form.target_amount.errors %}
                                        <div class="text-danger small">{{ form.target_amount.errors }}</div>
                                    {% endif %}
                                    <div class="form-text">Minimum amount is 1 EGP</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.start_date.id_for_label }}" class="form-label">Start Date & Time *</label>
                                    {{ form.start_date }}
                                    {% if form.start_date.errors %}
                                        <div class="text-danger small">{{ form.start_date.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.end_date.id_for_label }}" class="form-label">End Date & Time *</label>
                                    {{ form.end_date }}
                                    {% if form.end_date.errors %}
                                        <div class="text-danger small">{{ form.end_date.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.tags.id_for_label }}" class="form-label">Select Existing Tags</label>
                            {{ form.tags }}
                            {% if form.tags.errors %}
                                <div class="text-danger small">{{ form.tags.errors }}</div>
                            {% endif %}
                            <div class="form-text">Hold Ctrl/Cmd to select multiple tags</div>
                        </div>

                        <!-- NEW TAGS FIELD ADDED HERE -->
                        <div class="mb-3">
                            <label for="{{ form.new_tags.id_for_label }}" class="form-label">Add New Tags</label>
                            {{ form.new_tags }}
                            {% if form.new_tags.errors %}
                                <div class="text-danger small">{{ form.new_tags.errors }}</div>
                            {% endif %}
                            <div class="form-text">Enter new tags separated by commas (e.g., "tech, innovation, startup")</div>
                        </div>

                        <!-- Main Project Image with Preview -->
                        <div class="mb-3">
                            <label for="{{ form.image.id_for_label }}" class="form-label">Main Project Image *</label>
                            
                            <div class="main-image-upload-container">
                                <!-- Selected image display -->
                                <div class="mb-3" id="mainImagePreviewContainer">
                                    <div class="empty-slot-main text-center p-4" id="mainImageEmptySlot">
                                        <i class="fas fa-cloud-upload-alt fa-3x mb-2 text-muted"></i>
                                        <p class="text-muted">Click to upload your main project image</p>
                                    </div>
                                    <div class="image-preview-card-main d-none" id="mainImagePreview">
                                        <img src="" class="preview-image-main" alt="Main project image preview">
                                        <button type="button" class="btn btn-danger btn-sm remove-main-image-btn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Hidden file input -->
                                <div class="d-none">
                                    {{ form.image }}
                                </div>
                                
                                <!-- Custom upload button -->
                                <div class="text-center">
                                    <button type="button" class="btn btn-outline-primary" id="uploadMainImageBtn">
                                        <i class="fas fa-upload me-1"></i>Select Main Image
                                    </button>
                                    <div class="form-text mt-1">JPG, PNG or GIF. Max size: 5MB</div>
                                </div>
                                
                                {% if form.image.errors %}
                                    <div class="text-danger small mt-2">{{ form.image.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Additional Images (Optional)</label>
                            
                            <div class="multi-image-upload-container">
                                <!-- Selected images display -->
                                <div class="row g-2 mb-3" id="selectedImagesContainer">
                                    <!-- Selected images will be added here -->
                                </div>
                                
                                <!-- Add more button -->
                                <div class="text-center">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="addAnotherImageBtn">
                                        <i class="fas fa-plus me-1"></i>Add Another Image
                                    </button>
                                    <div class="form-text mt-1">You can add up to 5 additional images</div>
                                </div>
                                
                                <!-- Hidden container for file inputs -->
                                <div id="fileInputsContainer" class="d-none">
                                    <!-- File inputs will be added here dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-rocket me-1"></i>Launch Project
                            </button>
                            <a href="{% url 'my_projects' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border: none;
        border-radius: 10px;
        transition: transform 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    
    .card-header {
        background: linear-gradient(to right, var(--primary), var(--secondary));
        color: white;
        border-bottom: none;
    }
    
    textarea {
        min-height: 120px;
        border-radius: 8px;
    }
    
    select[multiple] {
        height: auto;
        min-height: 120px;
        border-radius: 8px;
    }
    
    /* Style for selected options */
    select[multiple] option:checked {
        background: linear-gradient(to right, var(--primary), var(--secondary));
        color: white;
    }
    
    .form-control {
        border-radius: 8px;
    }
    
    .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.25rem rgba(78, 84, 200, 0.25);
    }
    
    .btn {
        border-radius: 50px;
        font-weight: 500;
    }
    
    .btn-primary {
        background: linear-gradient(to right, var(--primary), var(--secondary));
        border: none;
    }
    
    .btn-primary:hover {
        background: linear-gradient(to right, var(--secondary), var(--primary));
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    
    .image-preview-card {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .image-preview-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .preview-image {
        height: 120px;
        object-fit: cover;
        width: 100%;
    }
    
    .remove-image-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        font-size: 12px;
    }
    
    .empty-slot {
        height: 120px;
        background-color: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .empty-slot:hover {
        border-color: var(--primary);
        background-color: rgba(78, 84, 200, 0.05);
        color: var(--primary);
    }
    
    /* Styles for main image preview */
    .empty-slot-main {
        background-color: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .empty-slot-main:hover {
        border-color: var(--primary);
        background-color: rgba(78, 84, 200, 0.05);
        color: var(--primary);
    }
    
    .image-preview-card-main {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transition: all 0.3s ease;
        max-width: 400px;
        margin: 0 auto;
    }
    
    .preview-image-main {
        width: 100%;
        max-height: 250px;
        object-fit: contain;
    }
    
    .remove-main-image-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
</style>

<!-- Add this JavaScript to your template -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const startDateInput = document.querySelector('input[name="start_date"]');
    const endDateInput = document.querySelector('input[name="end_date"]');
    
    // Add required attribute to date fields
    if (startDateInput) startDateInput.required = true;
    if (endDateInput) endDateInput.required = true;
    
    // Client-side validation
    if (form) {
        form.addEventListener('submit', function(e) {
            if (startDateInput && endDateInput && startDateInput.value && endDateInput.value) {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                const now = new Date();
                
                if (startDate >= endDate) {
                    e.preventDefault();
                    alert('End date must be after start date.');
                    return false;
                }
                
                if (startDate <= now) {
                    e.preventDefault();
                    alert('Start date must be in the future.');
                    return false;
                }
            }
        });
    }
    
    // Set minimum datetime for start date (current time)
    if (startDateInput) {
        const now = new Date();
        // Format to YYYY-MM-DDTHH:MM (datetime-local format)
        const minDate = now.toISOString().slice(0, 16);
        startDateInput.min = minDate;
        
        startDateInput.addEventListener('change', function() {
            if (endDateInput && this.value) {
                // Set minimum end date to be after start date
                const startDate = new Date(this.value);
                startDate.setMinutes(startDate.getMinutes() + 1);
                endDateInput.min = startDate.toISOString().slice(0, 16);
            }
        });
    }

    // Main Image Upload Functionality
    const mainImageInput = document.querySelector('input[type="file"][name="image"]');
    const mainImageEmptySlot = document.getElementById('mainImageEmptySlot');
    const mainImagePreview = document.getElementById('mainImagePreview');
    const mainImagePreviewImg = mainImagePreview.querySelector('img');
    const removeMainImageBtn = document.querySelector('.remove-main-image-btn');
    const uploadMainImageBtn = document.getElementById('uploadMainImageBtn');
    
    // Trigger file input when clicking on empty slot or upload button
    if (mainImageEmptySlot) {
        mainImageEmptySlot.addEventListener('click', function() {
            mainImageInput.click();
        });
    }
    
    if (uploadMainImageBtn) {
        uploadMainImageBtn.addEventListener('click', function() {
            mainImageInput.click();
        });
    }
    
    // Handle file selection for main image
    if (mainImageInput) {
        mainImageInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                // Validate file type
                if (!file.type.match('image.*')) {
                    alert('Please select an image file (JPG, PNG, GIF)');
                    this.value = '';
                    return;
                }
                
                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB');
                    this.value = '';
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Show preview and hide empty slot
                    mainImagePreviewImg.src = e.target.result;
                    mainImageEmptySlot.classList.add('d-none');
                    mainImagePreview.classList.remove('d-none');
                }
                
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Remove main image
    if (removeMainImageBtn) {
        removeMainImageBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Clear the file input
            mainImageInput.value = '';
            
            // Show empty slot and hide preview
            mainImageEmptySlot.classList.remove('d-none');
            mainImagePreview.classList.add('d-none');
        });
    }
    
    // Additional Images Functionality (existing code)
    const selectedImagesContainer = document.getElementById('selectedImagesContainer');
    const fileInputsContainer = document.getElementById('fileInputsContainer');
    const addAnotherImageBtn = document.getElementById('addAnotherImageBtn');
    const maxImages = 5;
    let imageCount = 0;
    
    // Initialize with empty slots
    function initializeEmptySlots() {
        selectedImagesContainer.innerHTML = '';
        for (let i = 0; i < maxImages; i++) {
            const col = document.createElement('div');
            col.className = 'col-md-3 col-6 mb-3';
            col.innerHTML = `
                <div class="empty-slot" data-index="${i}">
                    <i class="fas fa-plus"></i>
                </div>
            `;
            selectedImagesContainer.appendChild(col);
            
            // Add click event to empty slots
            col.querySelector('.empty-slot').addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                triggerFileInput(index);
            });
        }
    }
    
    // Initialize on page load
    initializeEmptySlots();
    
    // Create a file input
    function createFileInput(index) {
        const input = document.createElement('input');
        input.type = 'file';
        input.name = 'additional_images';
        input.accept = 'image/*';
        input.style.display = 'none';
        input.setAttribute('data-index', index);
        
        input.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                handleFileSelection(this.files[0], index);
            }
        });
        
        fileInputsContainer.appendChild(input);
        return input;
    }
    
    // Trigger file input click
    function triggerFileInput(index) {
        let input = fileInputsContainer.querySelector(`input[data-index="${index}"]`);
        
        if (!input) {
            input = createFileInput(index);
        }
        
        input.click();
    }
    
    // Handle file selection
    function handleFileSelection(file, index) {
        if (!file.type.match('image.*')) {
            alert('Please select an image file');
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            updateImagePreview(e.target.result, index, file.name);
            imageCount++;
            updateAddButtonState();
        }
        
        reader.readAsDataURL(file);
    }
    
    // Update image preview
    function updateImagePreview(imageData, index, fileName) {
        const slot = selectedImagesContainer.querySelector(`.empty-slot[data-index="${index}"]`);
        
        if (slot) {
            slot.outerHTML = `
                <div class="image-preview-card">
                    <img src="${imageData}" class="preview-image" alt="Preview">
                    <button type="button" class="btn btn-danger btn-sm remove-image-btn" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Add event listener to remove button
            const removeBtn = selectedImagesContainer.querySelector(`.remove-image-btn[data-index="${index}"]`);
            removeBtn.addEventListener('click', function() {
                removeImage(index);
            });
        }
    }
    
    // Remove image
    function removeImage(index) {
        // Remove the file input
        const input = fileInputsContainer.querySelector(`input[data-index="${index}"]`);
        if (input) {
            input.remove();
        }
        
        // Replace with empty slot
        const previewCard = selectedImagesContainer.querySelector(`.image-preview-card`);
        if (previewCard) {
            previewCard.outerHTML = `
                <div class="empty-slot" data-index="${index}">
                    <i class="fas fa-plus"></i>
                </div>
            `;
            
            // Add click event to the new empty slot
            const emptySlot = selectedImagesContainer.querySelector(`.empty-slot[data-index="${index}"]`);
            emptySlot.addEventListener('click', function() {
                const slotIndex = parseInt(this.getAttribute('data-index'));
                triggerFileInput(slotIndex);
            });
        }
        
        imageCount--;
        updateAddButtonState();
    }
    
    // Update add button state
    function updateAddButtonState() {
        if (imageCount >= maxImages) {
            addAnotherImageBtn.disabled = true;
            addAnotherImageBtn.innerHTML = '<i class="fas fa-ban me-1"></i>Maximum reached';
        } else {
            addAnotherImageBtn.disabled = false;
            addAnotherImageBtn.innerHTML = '<i class="fas fa-plus me-1"></i>Add Another Image';
        }
    }
    
    // Add another image button handler
    addAnotherImageBtn.addEventListener('click', function() {
        // Find the first empty slot
        const emptySlots = selectedImagesContainer.querySelectorAll('.empty-slot');
        if (emptySlots.length > 0) {
            const firstEmptySlot = emptySlots[0];
            const index = parseInt(firstEmptySlot.getAttribute('data-index'));
            triggerFileInput(index);
        }
    });
});
</script>
{% endblock %}